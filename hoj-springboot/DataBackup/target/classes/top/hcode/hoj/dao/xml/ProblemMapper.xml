<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="top.hcode.hoj.dao.ProblemMapper">

    <resultMap id="map_ProblemList" type="top.hcode.hoj.pojo.vo.ProblemVo">
        <id column="pid" property="pid"></id>
        <result column="title" property="title"></result>
        <result column="difficulty" property="difficulty"></result>
        <result column="type" property="type"></result>
        <result column="total" property="total"></result>
        <result column="ac" property="ac"></result>
        <result column="mle" property="mle"></result>
        <result column="tle" property="tle"></result>
        <result column="re" property="re"></result>
        <result column="pe" property="pe"></result>
        <result column="ce" property="ce"></result>
        <result column="wa" property="wa"></result>
        <result column="se" property="se"></result>
        <result column="pa" property="pa"></result>
        <collection property="tags" ofType="top.hcode.hoj.pojo.entity.Tag" select="getProblemTag" column="pid">
        </collection>
    </resultMap>

    <!-- 主查询 -->
    <select id="getProblemList" resultMap="map_ProblemList">
        SELECT distinct p.id as pid,p.title,p.difficulty,p.type,pc.total,pc.ac,pc.mle,pc.tle,pc.re,
        pc.pe,pc.ce,pc.wa,pc.se,pc.pa FROM problem p
        LEFT JOIN problem_count pc ON p.id = pc.pid
        LEFT JOIN problem_tag pt ON p.id = pt.pid
        <where>
            p.auth = 1
            <if test="keyword != null and keyword != ''">
                and (
                p.title = #{keyword}
                <if test="pid != null and pid != ''">
                    or p.id = #{pid}
                </if>
                )
            </if>
            <if test="difficulty != null">
                and p.difficulty = #{difficulty}
            </if>
            <if test="tid != null">
                and pt.tid = #{tid}
            </if>
        </where>
        order by p.id asc
    </select>

    <!-- 子查询 :为了防止分页总数据数出错-->
    <select id="getProblemTag" resultType="top.hcode.hoj.pojo.entity.Tag">
        select t.* from tag t,problem_tag pt where t.id = pt.tid and pt.pid = #{pid}
    </select>




</mapper>
