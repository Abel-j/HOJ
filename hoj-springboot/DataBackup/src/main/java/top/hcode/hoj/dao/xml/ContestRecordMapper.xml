<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="top.hcode.hoj.dao.ContestRecordMapper">

    <select id="getACInfo" resultType="top.hcode.hoj.pojo.entity.ContestRecord">
        SELECT c.id,c.uid,c.username,c.display_id,c.cid,c.realname,c.pid,c.time,c.status,c.checked,c.submit_id,
        c.submit_time FROM contest_record c,
        (SELECT status,uid,pid,cpid,
        MIN(submit_id) AS min_submit_id,
        MIN(submit_time) AS min_submit_time
        FROM contest_record GROUP BY status,uid,pid,cpid
        ) AS t
        <where>
            t.status = c.status AND t.uid=c.uid AND t.pid=c.pid
            AND t.cpid=c.cpid
            AND t.min_submit_id=c.submit_id
            AND t.min_submit_time=c.submit_time
            <if test="status!=null">
                AND c.status=#{status}
            </if>
            <if test="cid!=null">
                AND c.cid = #{cid}
            </if>
        </where>
        ORDER BY c.checked ASC,c.submit_time DESC
    </select>

    <select id="getOIContestRecord" resultType="top.hcode.hoj.pojo.entity.ContestRecord">
        SELECT cr.* FROM
        (SELECT uid,pid,cpid,MAX(time) AS time FROM contest_record
        <where>
            cid=#{cid} AND status IS NOT NULL
            <if test="contestAuthor!=null">
                AND username!=#{contestAuthor}
            </if>
            <choose>
                <when test="isOpenSealRank">
                    AND submit_time BETWEEN #{startTime} AND #{sealTime}
                </when>
                <otherwise>
                    AND submit_time BETWEEN #{startTime} AND #{endTime}
                </otherwise>
            </choose>
        </where>
         GROUP BY uid,pid,cpid) t
        LEFT JOIN contest_record cr ON t.uid = cr.uid AND t.pid =cr.pid
        AND t.cpid = cr.cpid AND t.time = cr.time
    </select>
</mapper>
